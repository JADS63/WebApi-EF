kind: pipeline
type: docker
name: CI/CD

trigger:
  event:
    - push

steps:
  - name: docker-build-and-push
    image: plugins/docker
    settings:
      dockerfile: Dockerfile  # Le Dockerfile est à la racine
      context: .  # Le contexte est la racine du dépôt
      registry: hub.codefirst.iut.uca.fr
      repo: hub.codefirst.iut.uca.fr/julien.araujo_da_silva/pm2_webapiandef_araujodasilva.julien
      username:
        from_secret: SECRET_REGISTRY_USERNAME
      password:
        from_secret: SECRET_REGISTRY_PASSWORD
    # Pas de depends_on, car c'est la première étape

  - name: deploy-container
    image: hub.codefirst.iut.uca.fr/thomas.bellembois/codefirst-dockerproxy-clientdrone:latest
    environment:
      IMAGENAME: hub.codefirst.iut.uca.fr/julien.araujo_da_silva/pm2_webapiandef_araujodasilva.julien:latest
      CONTAINERNAME: pm2-webapi
      COMMAND: create
      OVERWRITE: true
      # URL de base de l'API sur CodeFirst (AVEC HTTPS et le chemin complet)
      CODEFIRST_CLIENTDRONE_ENV_API_BASE_URL: https://julienaraujo_da_silva-pm2-webapi.apps.codefirst.iut.uca.fr/api/v1/Players
    depends_on:
      - docker-build-and-push